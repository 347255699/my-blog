(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{361:function(a,t,s){"use strict";s.r(t);var r=s(9),e=Object(r.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("p",[a._v("通常情况下我们需要一个类似 Java Maven Nexus 一样的私库作为我们私有注册中心以便用来维护我们的应用容器。")]),a._v(" "),s("h2",{attrs:{id:"_1-docker-compose"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-docker-compose"}},[a._v("#")]),a._v(" 1. docker-compose")]),a._v(" "),s("p",[a._v("这里我们选择 docker-compose 的方式来安装。"),s("a",{attrs:{href:"https://github.com/docker/compose/releases",target:"_blank",rel:"noopener noreferrer"}},[a._v("查询 docker-compose releases"),s("OutboundLink")],1)]),a._v(" "),s("p",[a._v("这里我们下载的版本是 "),s("a",{attrs:{href:"https://github.com/docker/compose/releases/tag/1.26.0-rc4",target:"_blank",rel:"noopener noreferrer"}},[a._v("1.26.0-rc4"),s("OutboundLink")],1),a._v("，选择二进制文件  "),s("a",{attrs:{href:"https://github.com/docker/compose/releases/download/1.26.0-rc4/docker-compose-Linux-x86_64",target:"_blank",rel:"noopener noreferrer"}},[a._v("docker-compose-Linux-x86_64"),s("OutboundLink")],1)]),a._v(" "),s("p",[a._v("这里我是通过本地 download 然后 scp 到虚拟机服务器的方式来安装。")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("scp")]),a._v(" docker-compose-Linux-x86_64 ubuntu0:/usr/local/bin\n")])])]),s("blockquote",[s("p",[a._v("这里的 ubuntu0 等价于 mendora@192.168.3.35。默认 /usr/local/bin 其他用户是没有写入权限的，我们需要添加 chmod 777 /usr/local/bin。或者通过 scp 到其他目录，再 mv 到 /usr/local/bin")])]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" /usr/local/bin "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mv")]),a._v(" docker-compose-Linux-x86_64 docker-compose\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" +x docker-compose\n")])])]),s("p",[a._v("确认下安装：")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("mendora@k8s-master:/usr/local/bin$ docker-compose --version\ndocker-compose version "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1.25")]),a._v(".5, build 8a1c60f6\n")])])]),s("h2",{attrs:{id:"_2-离线安装-harbor"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-离线安装-harbor"}},[a._v("#")]),a._v(" 2. 离线安装 Harbor")]),a._v(" "),s("p",[s("a",{attrs:{href:"https://github.com/goharbor/harbor/releases",target:"_blank",rel:"noopener noreferrer"}},[a._v("查询 harbor releases"),s("OutboundLink")],1)]),a._v(" "),s("p",[a._v("这里我们下载的版本是 "),s("a",{attrs:{href:"https://github.com/goharbor/harbor/releases/tag/v2.0.0-rc2",target:"_blank",rel:"noopener noreferrer"}},[a._v("v2.0.0-rc2"),s("OutboundLink")],1),a._v("，选择压缩包 "),s("a",{attrs:{href:"https://github.com/goharbor/harbor/releases/download/v2.0.0-rc2/harbor-offline-installer-v2.0.0-rc2.tgz",target:"_blank",rel:"noopener noreferrer"}},[a._v("harbor-offline-installer-v2.0.0-rc2.tgz"),s("OutboundLink")],1)]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("scp")]),a._v(" harbor-offline-installer-v2.0.0-rc2.tgz ubuntu0:/opt\n")])])]),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" /opt "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" -zxvf harbor-offline-installer-v2.0.0-rc2.tgz\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" installed "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mv")]),a._v(" harbor-offline-installer-v2.0.0-rc2.tgz ./installed\n")])])]),s("p",[a._v("我们 cd 到 harbor 文件夹，能看到如下列表：")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("mendora@k8s-master:/opt$ "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" harbor "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ls")]),a._v("\ncommon.sh  harbor.v2.0.0.tar.gz  harbor.yml.tmpl  install.sh  LICENSE  prepare\n")])])]),s("p",[a._v("接下来我们需要修改 harbor.yml.tmpl 配置文件，此时配置文件是临时的还不能被使用。我需要修改一下并重命名。")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" harbor.yml.tmpl\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mv")]),a._v(" harbor.yml.tmpl harbor.yml\n")])])]),s("h3",{attrs:{id:"_2-1-配置-https"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-配置-https"}},[a._v("#")]),a._v(" 2.1 配置 https")]),a._v(" "),s("h4",{attrs:{id:"_2-1-1-配置域名"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-1-配置域名"}},[a._v("#")]),a._v(" 2.1.1 配置域名")]),a._v(" "),s("p",[a._v("配置一个虚拟的域名，以方便后续的镜像推送和拉取。\n在需要访问 harbor 的机器上设置 hosts。")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("192.168")]),a._v(".3.35 harbor.com "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">>")]),a._v(" /etc/hosts\n")])])]),s("h4",{attrs:{id:"_2-1-2-自签名证书"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-2-自签名证书"}},[a._v("#")]),a._v(" 2.1.2 自签名证书")]),a._v(" "),s("p",[a._v("这里我们是在本地环境部署的 harbor 并不需要真的买一个证书，这里我们采用自签名证书即可。"),s("br"),a._v("\n这里我们通过 openssl 来生成。")]),a._v(" "),s("blockquote",[s("p",[a._v("记得在证书生成的过程中将 harbor.com 换成你自己的域名。")])]),a._v(" "),s("h5",{attrs:{id:"ca-证书"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ca-证书"}},[a._v("#")]),a._v(" CA 证书")]),a._v(" "),s("p",[a._v("生成 CA 私钥：")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("openssl genrsa -out ca.key "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4096")]),a._v("\n")])])]),s("p",[a._v("生成 CA 证书：")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("openssl req -x509 -new -nodes -sha512 -days "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3650")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n -subj "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.com"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n -key ca.key "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n -out ca.crt\n")])])]),s("h5",{attrs:{id:"服务器证书"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务器证书"}},[a._v("#")]),a._v(" 服务器证书")]),a._v(" "),s("p",[a._v("生成私钥：")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("openssl genrsa -out harbor.com.key "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4096")]),a._v("\n")])])]),s("p",[a._v("生成 CSR:")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("openssl req -sha512 -new "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -subj "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.com"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -key harbor.com.key "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -out harbor.com.csr\n")])])]),s("p",[a._v("生成 x509 v3 扩展文件：")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" v3.ext "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<<-")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("EOF\nauthorityKeyIdentifier=keyid,issuer\nbasicConstraints=CA:FALSE\nkeyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment\nextendedKeyUsage = serverAuth\nsubjectAltName = @alt_names\n\n[alt_names]\nDNS.1=harbor.com\nDNS.2=harbor\nDNS.3=192.168.3.35\nEOF")]),a._v("\n")])])]),s("p",[a._v("使用 v3.ext 为我们的机器生成证书：")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("openssl x509 -req -sha512 -days "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3650")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -extfile v3.ext "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -CA ca.crt -CAkey ca.key -CAcreateserial "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -in harbor.com.csr "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -out harbor.com.crt\n")])])]),s("h4",{attrs:{id:"_2-1-3-为-docker-和-harbor-提供证书"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-3-为-docker-和-harbor-提供证书"}},[a._v("#")]),a._v(" 2.1.3 为 Docker 和 harbor 提供证书")]),a._v(" "),s("p",[a._v("复制证书到 harbor 主机上：")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" harbor.com.crt /opt/harbor/data/cert/\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" harbor.com.key /opt/harbor/data/cert/\n")])])]),s("blockquote",[s("p",[a._v("默认 harboar data 目录是在 /data，因此你需要复制证书到 /data/cert/ 下。data 目录可以在 harbor.yml 中配置。")])]),a._v(" "),s("p",[a._v("将 harbor.com.crt 转换为 harbor.com.cert 以便给 Docker 使用：")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("openssl x509 -inform PEM -in harbor.com.crt -out harbor.com.cert\n")])])]),s("p",[a._v("拷贝服务器证书以及 CA 文件到 Docker 证书目录下：")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" harbor.com.cert /etc/docker/certs.d/harbor.com/\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" harbor.com.key /etc/docker/certs.d/harbor.com/\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" ca.crt /etc/docker/certs.d/harbor.com/\n")])])]),s("p",[a._v("重启Docker:")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("systemctl restart docker\n")])])]),s("p",[a._v("最后你能看到 docker 的证书目录：")]),a._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("/etc/docker/certs.d/\n    └── harbor.com:port\n       ├── harbor.com.cert  <-- Server certificate signed by CA\n       ├── harbor.com.key   <-- Server key signed by CA\n       └── ca.crt               <-- Certificate authority that signed the registry certificate\n")])])]),s("h4",{attrs:{id:"_2-1-4-配置-harbor-yml"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-4-配置-harbor-yml"}},[a._v("#")]),a._v(" 2.1.4  配置 harbor.yml")]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("hostname")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" harbor.com\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# http related config")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("http")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# port for http, default is 80. If https enabled, this port will redirect to https port")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("port")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("80")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# https related config")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("https")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# https port for harbor, default is 443")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("port")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("443")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# The path of cert and key files for nginx")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("certificate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" /opt/harbor/data/cert/harbor.com.crt\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("private_key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" /opt/harbor/data/cert/harbor.com.key\n")])])]),s("blockquote",[s("p",[a._v("这里除了配置域名和开启 https 外，还需要设置 admin 账户密码，数据库密码，data 目录等。按实际需要来配置就好。")])]),a._v(" "),s("h3",{attrs:{id:"_2-2-启动脚本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-启动脚本"}},[a._v("#")]),a._v(" 2.2 启动脚本")]),a._v(" "),s("p",[a._v("启动安装脚本：")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("./prepare.sh\n./install.sh\n")])])]),s("p",[a._v("看到如下信息代表安装完成了。")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("Creating network "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"harbor_harbor"')]),a._v(" with the default driver\nCreating harbor-log "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("done")]),a._v("\nCreating harbor-portal "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("done")]),a._v("\nCreating redis         "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("done")]),a._v("\nCreating registry      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("done")]),a._v("\nCreating harbor-db     "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("done")]),a._v("\nCreating registryctl   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("done")]),a._v("\nCreating harbor-core   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("done")]),a._v("\nCreating harbor-jobservice "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("done")]),a._v("\nCreating nginx             "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("done")]),a._v("\n✔ ----Harbor has been installed and started successfully.----\n")])])]),s("p",[a._v("访问我们的 harbor。")]),a._v(" "),s("div",{staticClass:"language-http extra-class"},[s("pre",{pre:!0,attrs:{class:"language-http"}},[s("code",[s("span",{pre:!0,attrs:{class:"token header-name keyword"}},[a._v("https:")]),a._v("//harbor.com\n")])])]),s("p",[a._v("使用 admin/[你设置的 admin 密码] 完成登录。")]),a._v(" "),s("p",[s("img",{attrs:{src:"/image/harbor.png",alt:"harbor"}})]),a._v(" "),s("p",[a._v("下一章我们将使用 harbor 来分发和部署我们的容器应用。")]),a._v(" "),s("h2",{attrs:{id:"参考资料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[a._v("#")]),a._v(" 参考资料")]),a._v(" "),s("ol",[s("li",[s("a",{attrs:{href:"https://www.cnblogs.com/majiang/p/11218792.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("dz45693"),s("OutboundLink")],1)]),a._v(" "),s("li",[s("a",{attrs:{href:"https://goharbor.io/docs/1.10/install-config/run-installer-script/",target:"_blank",rel:"noopener noreferrer"}},[a._v("官方文档——Run the Installer Script"),s("OutboundLink")],1)])]),a._v(" "),s("comment"),a._v(" "),s("comment")],1)}),[],!1,null,null,null);t.default=e.exports}}]);