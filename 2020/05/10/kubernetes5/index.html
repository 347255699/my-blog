<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>认真学习 kubernetes——Pod 的基本使用 | Menfre Blog</title>
    <meta name="description" content="通过前面的学习，我们知道 Pod 是 kubernetes 最小的调度单位。如果将 Pod 落实到 API 对象上，那么 container 则是 Pod 上的一个字段。这里我们需要搞清楚哪些属性是属于容器哪些是属于 Pod。

凡是调度、网络、存储以及安全相关的属性基本都是 Pod 级别的。

接下来我们来学习 Pod 中几个重要的字段。

NodeSelector：是一个将 Pod 和 ...">
    <meta name="generator" content="VuePress 1.4.0">
    <script src="https://www.googletagmanager.com/gtag/js?id=UA-164957843-1" async="true"></script>
  <script>window.dataLayer = window.dataLayer || [];            function gtag(){dataLayer.push(arguments);}            gtag('js', new Date());            gtag('config', 'UA-164957843-1');</script>
    
    <link rel="preload" href="/assets/css/0.styles.0a94a68e.css" as="style"><link rel="preload" href="/assets/js/app.8d42fabb.js" as="script"><link rel="preload" href="/assets/js/6.aea618f8.js" as="script"><link rel="preload" href="/assets/js/4.20006588.js" as="script"><link rel="preload" href="/assets/js/24.92afe763.js" as="script"><link rel="preload" href="/assets/js/7.403b6e6e.js" as="script"><link rel="prefetch" href="/assets/js/1.5cbf5643.js"><link rel="prefetch" href="/assets/js/10.3ae75870.js"><link rel="prefetch" href="/assets/js/11.a447f3c3.js"><link rel="prefetch" href="/assets/js/12.0449ba3d.js"><link rel="prefetch" href="/assets/js/13.75011fc7.js"><link rel="prefetch" href="/assets/js/14.572779d4.js"><link rel="prefetch" href="/assets/js/15.d8496b36.js"><link rel="prefetch" href="/assets/js/16.3c7370c7.js"><link rel="prefetch" href="/assets/js/17.f10c6f39.js"><link rel="prefetch" href="/assets/js/18.1abb8aa8.js"><link rel="prefetch" href="/assets/js/19.5ca12b0a.js"><link rel="prefetch" href="/assets/js/20.e1896da5.js"><link rel="prefetch" href="/assets/js/21.b5e744b7.js"><link rel="prefetch" href="/assets/js/22.01ca19aa.js"><link rel="prefetch" href="/assets/js/23.2aa5172f.js"><link rel="prefetch" href="/assets/js/25.fad419e7.js"><link rel="prefetch" href="/assets/js/26.24545015.js"><link rel="prefetch" href="/assets/js/27.510e6dd2.js"><link rel="prefetch" href="/assets/js/28.12988af6.js"><link rel="prefetch" href="/assets/js/29.44772bc6.js"><link rel="prefetch" href="/assets/js/30.a1349a06.js"><link rel="prefetch" href="/assets/js/31.0d024f90.js"><link rel="prefetch" href="/assets/js/32.e66d53ec.js"><link rel="prefetch" href="/assets/js/33.96fc1f36.js"><link rel="prefetch" href="/assets/js/34.fd98863d.js"><link rel="prefetch" href="/assets/js/35.388ea9a8.js"><link rel="prefetch" href="/assets/js/36.1d19334a.js"><link rel="prefetch" href="/assets/js/5.ef32696c.js"><link rel="prefetch" href="/assets/js/8.c5b9daff.js"><link rel="prefetch" href="/assets/js/9.42728225.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.dd605d22.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0a94a68e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Menfre Blog </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Menfre Blog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        认真学习 kubernetes——Pod 的基本使用
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">Menfre</span> <span itemprop="address">   in Shenzhen</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2020-05-10T00:00:00.000Z">
      2020-05-10
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-d832e844><a href="/tag/k8s" data-v-d832e844> k8s </a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>通过前面的学习，我们知道 Pod 是 kubernetes 最小的调度单位。如果将 Pod 落实到 API 对象上，那么 container 则是 Pod 上的一个字段。这里我们需要搞清楚哪些属性是属于容器哪些是属于 Pod。</p> <p>凡是调度、网络、存储以及安全相关的属性基本都是 Pod 级别的。</p> <p>接下来我们来学习 Pod 中几个重要的字段。</p> <p><strong>NodeSelector</strong>：是一个将 Pod 和 Node 绑定的字段。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token punctuation">...</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
 <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
   <span class="token key atrule">disktype</span><span class="token punctuation">:</span> ssd
</code></pre></div><p>这样一个配置，意味着 Pod 只能被带有 disktype:ssd 标签的节点调度，否则就会失败。</p> <p><strong>NodeName</strong>：一旦 Pod 上这个字段被赋值意味着 Pod 已经被某个节点成功调度了。该字段只会被调度器设置。但是我们也可以手动设置来骗过调度器。</p> <p><strong>HostAliases</strong>：定义 Pod 中的 hosts 文件，即设置 /etc/hosts。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token punctuation">...</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hostAliases</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> <span class="token string">&quot;10.1.2.3&quot;</span>
    <span class="token key atrule">hostnames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;foo.remote&quot;</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;bar.remote&quot;</span>
<span class="token punctuation">...</span>
</code></pre></div><p>如下是设置完成后的 /etc/hosts。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>cat /etc/hosts
<span class="token comment"># Kubernetes-managed hosts file.</span>
127.0.0.1 localhost
<span class="token punctuation">...</span>
10.244.135.10 hostaliases<span class="token punctuation">-</span>pod
10.1.2.3 foo.remote
10.1.2.3 bar.remote
</code></pre></div><p>这里需要注意的是，为 Pod 中的容器设置 hosts 只能通过这种方式，如果是在容器运行时直接修改 /etc/hosts 会在 Pod 被删除和创建时被重新设置。</p> <p>除了上述 hosts 配置外，凡是跟容器的 Linux Namespace 相关的属性就一定是 Pod 级别的。</p> <p>这里可以跟虚拟机与虚拟机上的应用做个比较，这里 Pod 就是虚拟机，容器就是虚拟机上的应用。因此不难想象，在虚拟机上的配置都应该是 Pod 级别的。</p> <p>比如 <strong>shareProcessNamespace=true</strong>：在容器间共享 pid。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">shareProcessNamespace</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> shell
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">stdin</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>这个 Pod 中我们声明了两个容器，nginx 和 一个开启了 tty 和 stdin 的 shell 容器。</p> <p>这里 shell 容器的效果等同于 docker run -it （it 分别是 stdin 和 tty 的意思）。</p> <p>这里我们实践一下：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create -f nginx.yaml
</code></pre></div><p>当 Pod 被创建完成之后我们就可以通过 kubectl attach 命令，链接 shell 容器的 tty 了。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl attach -it nginx -c shell
</code></pre></div><p>我们可以在 shell 执行 ps 来尝试共享 pid namespace 的效果。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl attach -it nginx -c shell
/ <span class="token comment"># ps ax</span>
PID   <span class="token environment constant">USER</span>     TIME  COMMAND
    <span class="token number">1</span> root      <span class="token number">0</span>:00 /pause
    <span class="token number">8</span> root      <span class="token number">0</span>:00 nginx: master process nginx -g daemon off<span class="token punctuation">;</span>
   <span class="token number">14</span> <span class="token number">101</span>       <span class="token number">0</span>:00 nginx: worker process
   <span class="token number">15</span> root      <span class="token number">0</span>:00 <span class="token function">sh</span>
   <span class="token number">21</span> root      <span class="token number">0</span>:00 <span class="token function">ps</span> ax
</code></pre></div><p>这里我们可以看到 infra 容器的 /pause 进程，以及 ngnix 进程和 sh 进程。</p> <p>同样的我们可以在 Pod 中共享宿主机的 Namespace。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hostIPC</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">hostPID</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> shell
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">stdin</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>这样我们就可以使用宿主机的进程，与宿主机进行 IPC 通信以及看到宿主机中的所有进程了。</p> <p>除这些字段外，Pod 中最重要的字段就是 <strong>container</strong> 了。除普通的 container 外，我们还接触 initContainer，它们的区别在于 initContainer 会先于普通的 container 并按照声明顺序执行。container 只要等到 initContainer 执行完成才会执行。</p> <p>kubernetes 中对 container 的定义与 docker 大致一样。如 image、command、workDir、ports 和 volumeMounts 等。如这些主要字段外还有一些需要注意的字段。</p> <p><strong>imagePullPolicy</strong>: 定义镜像的拉取策略。</p> <ul><li>Always：每次创建 Pod 都重新拉取一次镜像，当拉取镜像的 tag 为 nginx 或 nginx:latest 也会起到相同的效果。</li> <li>Never/IfNotPresent：不主动拉取镜像，只有在宿主机中不存在才会主动拉取。</li></ul> <p><strong>lifecycle</strong>：它定义的是容器的生命周期 Hooks。</p> <p>lifecycle的作用是在容器的状态发生变化时触发一系列 “钩子”。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> lifecycle<span class="token punctuation">-</span>demo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lifecycle<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>container
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
      <span class="token key atrule">postStart</span><span class="token punctuation">:</span>
        <span class="token key atrule">exec</span><span class="token punctuation">:</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;echo Hello from the postStart handler &gt; /usr/share/message&quot;</span><span class="token punctuation">]</span>
      <span class="token key atrule">preStop</span><span class="token punctuation">:</span>
        <span class="token key atrule">exec</span><span class="token punctuation">:</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/usr/sbin/nginx&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-s&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;quit&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>这里我们为 lifecycle-demo-container 容器定义了生命周期钩子 postStart 和 preStop。</p> <ul><li>postStart：容器指定后立即执行一个操作，需要注意的是，这里并不能保证在 ENTRYPOINT 之后执行。</li> <li>preStop：容器在被杀死前(收到 SIGKILL 信号)执行。这里是同步的，只有钩子执行完成才会杀死容器。
这里的例子是在容器启动后在 /usr/share/message 中写入一条 hello message。在容器关闭之前调用 nginx 的退出命令。</li></ul> <p>这里我们可以大致的了解下 Pod 在 kubernetes 中的生命周期。</p> <p>Pod 的生命周期主要体现在 API 的 <strong>Status</strong> 字段。它是除了 Metadata 和 Spec 之外第三个比较重要的字段。其中 pod.status.phase 就是 Pod 当前的状态。状态列表如下：</p> <ul><li>Pending：表示 Pod 的 yaml 文件已经提交给 kubernetes 并保存在 Etcd 中，但出于其他原因未能被成功创建。</li> <li>Running：表示 Pod 已经成功被某一节点调度，且至少有一个容器在运行中了。</li> <li>Succeeded：表示 Pod 的所有容器都正常运行并成功退出了，这种情况在一次性任务中很常见。</li> <li>Failed：表示 Pod 中至少有一个容器不正常退出(非 0 返回码)退出。这个时候就要想办法 Debug 容器了，通过 Events 等。</li> <li>Unknown：表示异常状态，意味着 Pod 状态未能被 kubelet 持续汇报给 kube-apiserver。可能是主从节点的通信出现问题了。</li></ul> <p>更进一步的，每一个 Status 还可以细分出一组 <strong>Conditions</strong> 。这些细分状态包含 PodScheduled、</p> <p>Ready、Initialized 和 Unschedulable。他们主要用于描述造成当前 Status 的原因。</p> <p>比如 Status 为 Pending，对应的 Condition 为 Unschedulable，则表示调度出了问题。</p> <p>又如 Ready Condition，表示 Pod 不仅正常启动(Running)且已经对外服务了。</p> <p>如果想知道 Pod Yaml 文件的全部字段，可以参考 $GOPATH/src/k8s.io/kubernetes/vendor/k8s.io/api/core/v1/types.go 下的 struct。</p> <div class="gitalk-container"><div id="gitalk-container"></div></div> <div class="gitalk-container"><div id="gitalk-container"></div></div></div> <footer><!----> <hr> <!----></footer></article> <!----></div></div> <footer class="footer" data-v-fdbf4940><div class="footer-left-wrap" data-v-fdbf4940><ul class="contact" data-v-fdbf4940><li class="contact-item" data-v-fdbf4940><a href="https://github.com/347255699" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-fdbf4940><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-fdbf4940><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-fdbf4940></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-fdbf4940><ul class="copyright" data-v-fdbf4940><li class="copyright-item" data-v-fdbf4940><a href="/2020/05/10/kubernetes5/.html" class="nav-link" data-v-fdbf4940>Copyright © 2020 Menfre Blog.</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8d42fabb.js" defer></script><script src="/assets/js/6.aea618f8.js" defer></script><script src="/assets/js/4.20006588.js" defer></script><script src="/assets/js/24.92afe763.js" defer></script><script src="/assets/js/7.403b6e6e.js" defer></script>
  </body>
</html>
