<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>认真学习 kubernetes——安装环境 | Menfre Blog</title>
    <meta name="description" content="

由于 qiong，买不起云服务器，这里我们直接在 mac 上安装虚拟机来创建环境，这里我们使用 Oracle 开源的 VirtualBox 作为我们的虚拟机。

机器配置：

ubuntu 64
8 G 内存
3 Core
10 G 存储

2. 安装 kubernetes

这里我们没有额外的机器了，因此只部署单节点，之后有额外的机器可以加入集群环境。

2. ...">
    <meta name="generator" content="VuePress 1.4.0">
    <script src="https://www.googletagmanager.com/gtag/js?id=UA-164957843-1" async="true"></script>
  <script>window.dataLayer = window.dataLayer || [];            function gtag(){dataLayer.push(arguments);}            gtag('js', new Date());            gtag('config', 'UA-164957843-1');</script>
    
    <link rel="preload" href="/assets/css/0.styles.0a94a68e.css" as="style"><link rel="preload" href="/assets/js/app.8d42fabb.js" as="script"><link rel="preload" href="/assets/js/6.aea618f8.js" as="script"><link rel="preload" href="/assets/js/4.20006588.js" as="script"><link rel="preload" href="/assets/js/20.e1896da5.js" as="script"><link rel="preload" href="/assets/js/7.403b6e6e.js" as="script"><link rel="prefetch" href="/assets/js/1.5cbf5643.js"><link rel="prefetch" href="/assets/js/10.3ae75870.js"><link rel="prefetch" href="/assets/js/11.a447f3c3.js"><link rel="prefetch" href="/assets/js/12.0449ba3d.js"><link rel="prefetch" href="/assets/js/13.75011fc7.js"><link rel="prefetch" href="/assets/js/14.572779d4.js"><link rel="prefetch" href="/assets/js/15.d8496b36.js"><link rel="prefetch" href="/assets/js/16.3c7370c7.js"><link rel="prefetch" href="/assets/js/17.f10c6f39.js"><link rel="prefetch" href="/assets/js/18.1abb8aa8.js"><link rel="prefetch" href="/assets/js/19.5ca12b0a.js"><link rel="prefetch" href="/assets/js/21.b5e744b7.js"><link rel="prefetch" href="/assets/js/22.01ca19aa.js"><link rel="prefetch" href="/assets/js/23.2aa5172f.js"><link rel="prefetch" href="/assets/js/24.92afe763.js"><link rel="prefetch" href="/assets/js/25.fad419e7.js"><link rel="prefetch" href="/assets/js/26.24545015.js"><link rel="prefetch" href="/assets/js/27.510e6dd2.js"><link rel="prefetch" href="/assets/js/28.12988af6.js"><link rel="prefetch" href="/assets/js/29.44772bc6.js"><link rel="prefetch" href="/assets/js/30.a1349a06.js"><link rel="prefetch" href="/assets/js/31.0d024f90.js"><link rel="prefetch" href="/assets/js/32.e66d53ec.js"><link rel="prefetch" href="/assets/js/33.96fc1f36.js"><link rel="prefetch" href="/assets/js/34.fd98863d.js"><link rel="prefetch" href="/assets/js/35.388ea9a8.js"><link rel="prefetch" href="/assets/js/36.1d19334a.js"><link rel="prefetch" href="/assets/js/5.ef32696c.js"><link rel="prefetch" href="/assets/js/8.c5b9daff.js"><link rel="prefetch" href="/assets/js/9.42728225.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.dd605d22.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0a94a68e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Menfre Blog </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Menfre Blog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        认真学习 kubernetes——安装环境
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">Menfre</span> <span itemprop="address">   in Shenzhen</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2020-05-06T00:00:00.000Z">
      2020-05-06
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-d832e844><a href="/tag/k8s" data-v-d832e844> k8s </a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="_1-安装机器"><a href="#_1-安装机器" class="header-anchor">#</a> 1. 安装机器</h2> <p>由于 qiong，买不起云服务器，这里我们直接在 mac 上安装虚拟机来创建环境，这里我们使用 Oracle 开源的 VirtualBox 作为我们的虚拟机。</p> <p>机器配置：</p> <ul><li>ubuntu 64</li> <li>8 G 内存</li> <li>3 Core</li> <li>10 G 存储</li></ul> <h2 id="_2-安装-kubernetes"><a href="#_2-安装-kubernetes" class="header-anchor">#</a> 2. 安装 kubernetes</h2> <p>这里我们没有额外的机器了，因此只部署单节点，之后有额外的机器可以加入集群环境。</p> <h3 id="_2-1-系统检查"><a href="#_2-1-系统检查" class="header-anchor">#</a> 2.1 系统检查</h3> <ul><li>切换 root 账号</li> <li>节点主机名唯一，写入 hosts</li> <li>禁止 swap 分区</li> <li>关闭防火墙</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 设置 root 密码，切换 root 用户</span>
<span class="token function">sudo</span> <span class="token function">passwd</span> root
<span class="token function">su</span> root
<span class="token comment"># 设置静态主机名</span>
hostnamectl set-hostname k8s-master
<span class="token comment"># Status: inactive</span>
ufw status 
<span class="token comment"># 临时关闭 swap</span>
swapoff -a
</code></pre></div><h3 id="_2-2-docker-ce"><a href="#_2-2-docker-ce" class="header-anchor">#</a> 2.2 docker-ce</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># step 1: 安装必要的一些系统工具</span>
<span class="token function">apt-get</span> -y <span class="token function">install</span> apt-transport-https ca-certificates <span class="token function">curl</span> software-properties-common

<span class="token comment"># step 2: 安装GPG证书</span>
<span class="token function">curl</span> -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class="token operator">|</span> apt-key <span class="token function">add</span> -

<span class="token comment"># Step 3: 写入软件源信息</span>
add-apt-repository <span class="token string">&quot;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="token variable"><span class="token variable">$(</span>lsb_release -cs<span class="token variable">)</span></span> stable&quot;</span>

<span class="token comment"># Step 4: 更新并安装 Docker-CE</span>
<span class="token function">apt-get</span> -y update

<span class="token comment"># 安装指定版本的Docker-CE:</span>
<span class="token comment"># Step 1: 查找Docker-CE的版本:</span>
<span class="token function">apt-cache</span> madison docker-ce

<span class="token comment"># sudo apt-get -y install docker-ce=[VERSION]   //安装格式</span>

<span class="token function">apt-get</span> -y <span class="token function">install</span> docker-ce<span class="token operator">=</span><span class="token number">18.06</span>.3~ce~3-0~ubuntu

<span class="token comment">###配置docker-hub源</span>
<span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
{
&quot;registry-mirrors&quot;: [&quot;https://dhq9bx4f.mirror.aliyuncs.com&quot;]
}
EOF</span>

systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl restart docker
</code></pre></div><h3 id="_2-3-kubeadm"><a href="#_2-3-kubeadm" class="header-anchor">#</a> 2.3 kubeadm</h3> <p>为方便部署容器，这里我们需要安装 kubernetes dashboard，因此需要确认下 dashboard 当前支持的最新的 kubernetes 版本。<a href="https://github.com/kubernetes/dashboard/releases/" target="_blank" rel="noopener noreferrer">链接到 dashboard releases<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>这里我们查询到 dashboard 支持的最新版本为 1.18。接下来我们需要安装的 kubelet、kubeadm、kubectl 均为 1.18。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y apt-transport-https
<span class="token function">curl</span> -fsSL https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class="token operator">|</span> apt-key <span class="token function">add</span> -
add-apt-repository <span class="token string">&quot;deb [arch=amd64] https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main&quot;</span>
<span class="token function">apt-get</span> update
<span class="token comment"># 查看1.18的最新版本，这里我们查村到最新版本为 1.18.2</span>
<span class="token function">apt-cache</span> madison kubelet kubectl kubeadm <span class="token operator">|</span><span class="token function">grep</span> <span class="token string">'1.18'</span>     
<span class="token comment"># 安装指定的版本</span>
<span class="token function">apt</span> <span class="token function">install</span> -y <span class="token assign-left variable">kubelet</span><span class="token operator">=</span><span class="token number">1.18</span>.2-00 <span class="token assign-left variable">kubectl</span><span class="token operator">=</span><span class="token number">1.18</span>.2-00 <span class="token assign-left variable">kubeadm</span><span class="token operator">=</span><span class="token number">1.18</span>.2-00        
</code></pre></div><p>确认安装已完成</p> <div class="language-shell extra-class"><pre class="language-shell"><code>root@k8s-master:/home/mendora<span class="token comment"># kubectl version --client=true -o yaml</span>
clientVersion:
  buildDate: <span class="token string">&quot;2020-04-16T11:56:40Z&quot;</span>
  compiler: gc
  gitCommit: 52c56ce7a8272c798dbc29846288d7cd9fbae032
  gitTreeState: clean
  gitVersion: v1.18.2
  goVersion: go1.13.9
  major: <span class="token string">&quot;1&quot;</span>
  minor: <span class="token string">&quot;18&quot;</span>
  platform: linux/amd64
</code></pre></div><p>配置 kubelet 禁用 swap</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">tee</span> /etc/default/kubelet <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
KUBELET_EXTRA_ARGS=&quot;--fail-swap-on=false&quot;
EOF</span>

systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl restart kubelet
</code></pre></div><blockquote><p>注意：目前 kubelet 服务启动异常是因为缺少很多参数配置文件，需要等待 kubeadm init 后生成才能正常启动</p></blockquote> <h3 id="_2-4-初始化-k8s"><a href="#_2-4-初始化-k8s" class="header-anchor">#</a> 2.4 初始化 k8s</h3> <p>使用 kubeadm init 初始化，这里用默认的容器仓库会比较慢，我们需要指定 aliyun 的容器仓库。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>registry.aliyuncs.com/google_containers
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>kubeadm init <span class="token punctuation">\</span>
  --kubernetes-version<span class="token operator">=</span>v1.18.2 <span class="token punctuation">\</span>
  --image-repository registry.aliyuncs.com/google_containers <span class="token punctuation">\</span>
  --pod-network-cidr<span class="token operator">=</span><span class="token number">10.24</span>.0.0/16 <span class="token punctuation">\</span>
  --ignore-preflight-errors<span class="token operator">=</span>Swap
</code></pre></div><p>看到如下信息就代表成功了。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span>

To start using your cluster, you need to run the following as a regular user:

  <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

You should now deploy a pod network to the cluster.
Run <span class="token string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:

kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.3.35:6443 --token y18cm0.gmqf40jm3954qs7n <span class="token punctuation">\</span>
    --discovery-token-ca-cert-hash sha256:801a774913200684ebc405c5728d40cb2b5c26c7c1effbd80513eb137651c7f5
</code></pre></div><p>创建一个常规的账户：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config
</code></pre></div><p>添加一个 k8s 网络容器：</p> <p>这里我们使用 flannel overlay 来实现多节点间的 pod 通信。</p> <p>我们需要访问到 github 的 yaml 文件来安装容器。github 上的静态资源通过 raw.githubusercontent.com 来访问，这里我们需要确保 raw.githubusercontent.com 域名不受污染。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">echo</span> <span class="token number">199.232</span>.68.133 raw.githubusercontent.com <span class="token operator">&gt;&gt;</span> /etc/hosts
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre></div><p>我们通过 kubectl get pods -A 来确认容器的运行情况：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>root@k8s-master:/etc<span class="token comment"># kubectl get pods -A</span>
NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE
kube-system   coredns-7ff77c879f-6j22p             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          24m
kube-system   coredns-7ff77c879f-97mm8             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          24m
kube-system   etcd-k8s-master                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          24m
kube-system   kube-apiserver-k8s-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          24m
kube-system   kube-controller-manager-k8s-master   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          24m
kube-system   kube-flannel-ds-amd64-dzqq9          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m31s
kube-system   kube-proxy-xphzw                     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          24m
kube-system   kube-scheduler-k8s-master            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          24m
</code></pre></div><h3 id="_2-5-dashboard"><a href="#_2-5-dashboard" class="header-anchor">#</a> 2.5 dashboard</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml
</code></pre></div><p>查询容器安装情况：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>root@k8s-master:/etc<span class="token comment"># kubectl get pods -A</span>
NAMESPACE              NAME                                         READY   STATUS    RESTARTS   AGE
kube-system            coredns-7ff77c879f-6j22p                     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          27m
kube-system            coredns-7ff77c879f-97mm8                     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          27m
kube-system            etcd-k8s-master                              <span class="token number">1</span>/1     Running   <span class="token number">0</span>          28m
kube-system            kube-apiserver-k8s-master                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          28m
kube-system            kube-controller-manager-k8s-master           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          28m
kube-system            kube-flannel-ds-amd64-dzqq9                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m20s
kube-system            kube-proxy-xphzw                             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          27m
kube-system            kube-scheduler-k8s-master                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          28m
kubernetes-dashboard   dashboard-metrics-scraper-6b4884c9d5-nw2gj   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          49s
kubernetes-dashboard   kubernetes-dashboard-7b544877d5-824nv        <span class="token number">1</span>/1     Running   <span class="token number">0</span>          49s
</code></pre></div><p>查询访问信息：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>root@k8s-master:/etc<span class="token comment"># kubectl get namespace</span>
NAME                   STATUS   AGE
default                Active   30m
kube-node-lease        Active   30m
kube-public            Active   30m
kube-system            Active   30m
kubernetes-dashboard   Active   3m11s
root@k8s-master:/etc<span class="token comment"># kubectl cluster-info</span>

Kubernetes master is running at https://192.168.3.35:6443
KubeDNS is running at https://192.168.3.35:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use <span class="token string">'kubectl cluster-info dump'</span><span class="token builtin class-name">.</span>
</code></pre></div><p>访问格式：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token header-name keyword">https:</span>//&lt;master-ip&gt;:&lt;apiserver-port&gt;/api/v1/namespaces/&lt;namespaces&gt;/services/https:kubernetes-dashboard:/proxy/
</code></pre></div><p>dashboard 访问地址：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token header-name keyword">https:</span>//192.168.3.35:6443/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/
</code></pre></div><p>这里我们还需要创建账户和制作证书才能访问。</p> <p>创建账户：</p> <p>admin-user.yaml</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span>user
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create -f admin-user.yaml
</code></pre></div><p>绑定角色：</p> <p>默认 kubeadm 已经为我们创建了 admin 角色，我们只需要绑定即可。</p> <p>dmin-user-role-binding.yaml</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span>user
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>admin
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span>user
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create -f  admin-user-role-binding.yaml
</code></pre></div><p>获取 Token：</p> <p>登录 dashboard 时，我们需要一个 Token。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>root@k8s-master:~/yaml<span class="token comment"># kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}')</span>
Name:         admin-user-token-f95cm
Namespace:    kube-system
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:  kubernetes.io/service-account.name: admin-user
              kubernetes.io/service-account.uid: 542a7d0d-ac84-4a87-bae4-d79f7aa03b19

Type:  kubernetes.io/service-account-token

Data
<span class="token operator">==</span><span class="token operator">==</span>
ca.crt:     <span class="token number">1025</span> bytes
namespace:  <span class="token number">11</span> bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IldjdXFlNXFIY0EwQ3p1YkpreW56RE9oODg2VXh0UG1acnNCZzFDbWNvRkkifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWY5NWNtIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI1NDJhN2QwZC1hYzg0LTRhODctYmFlNC1kNzlmN2FhMDNiMTkiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.UdbFGS0DkBI8Ut7AL8z9jI0J-gfA80PI5x0WssP2_t5TW-AdocphGzQHw-GXXZJrBfqDKqm5L0hQ0KGaB7OY5mBb3LlxGXm5VjdKvmPfLlGpAhGZP7EPOfOEHeA54mp45l_JC9EQWz49mvHu8dNipSClg5l8Pxy_K7OqynHAQUOoyjO0bSYM3Q1ZjPzOBWUZgvRQcCgB3hhcDcAQ25sYmvokdA55ViyP77tqgfnwHr5t_jexflha-4uAm0mCCcILthjEWknD7Xj1gAscetvxX2mlD4fSJbr8qDzNagBmnz1DOys9gWSEDbfGvJfwjrY_eme_Zkj8FGJsKyscPfRmYw
</code></pre></div><p>制作证书：</p> <p>k8s 默认启用了 RBAC，并为未认证用户赋予了一个默认的身份 anonymous。对于 API Server 来说，它是使用证书进行认证的，我们需要先创建一个证书。</p> <p>我们使用client-certificate-data和client-key-data生成一个p12文件。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 生成client-certificate-data</span>
<span class="token function">grep</span> <span class="token string">'client-certificate-data'</span> ~/.kube/config <span class="token operator">|</span> <span class="token function">head</span> -n <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$2</span>}'</span> <span class="token operator">|</span> base64 -d <span class="token operator">&gt;&gt;</span> kubecfg.crt

<span class="token comment"># 生成client-key-data</span>
<span class="token function">grep</span> <span class="token string">'client-key-data'</span> ~/.kube/config <span class="token operator">|</span> <span class="token function">head</span> -n <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$2</span>}'</span> <span class="token operator">|</span> base64 -d <span class="token operator">&gt;&gt;</span> kubecfg.key

<span class="token comment"># 生成p12</span>
openssl pkcs12 -export -clcerts -inkey kubecfg.key -in kubecfg.crt -out kubecfg.p12 -name <span class="token string">&quot;kubernetes-client&quot;</span>
</code></pre></div><p>下载生成 kubecfg.p12 文件，并在本地双击完成证书安装。</p> <p>Ok, 接下来我们就可以访问链接了。https://192.168.3.35:6443/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</p> <p>一切顺利我们会得到如下登录界面，这里我们使用前面生成的 Token 登录。</p> <p><img src="/image/kubernetes-dashboard-login.jpg" alt="kubernetes-dashboard-login"></p> <p>最终我们登录完成进入控制台：</p> <p><img src="/image/kubernetes-dashboar-index.jpg" alt="kubernetes-dashboar-index"></p> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <p><a href="https://www.cnblogs.com/xiaochina/p/11650520.html" target="_blank" rel="noopener noreferrer">mvpbang<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="gitalk-container"><div id="gitalk-container"></div></div> <div class="gitalk-container"><div id="gitalk-container"></div></div></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#_1-安装机器" title="1. 安装机器">1. 安装机器</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_2-安装-kubernetes" title="2. 安装 kubernetes">2. 安装 kubernetes</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-1-系统检查" title="2.1 系统检查">2.1 系统检查</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-2-docker-ce" title="2.2 docker-ce">2.2 docker-ce</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-3-kubeadm" title="2.3 kubeadm">2.3 kubeadm</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-4-初始化-k8s" title="2.4 初始化 k8s">2.4 初始化 k8s</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-5-dashboard" title="2.5 dashboard">2.5 dashboard</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#参考资料" title="参考资料">参考资料</a></div></div></div></div> <footer class="footer" data-v-fdbf4940><div class="footer-left-wrap" data-v-fdbf4940><ul class="contact" data-v-fdbf4940><li class="contact-item" data-v-fdbf4940><a href="https://github.com/347255699" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-fdbf4940><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-fdbf4940><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-fdbf4940></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-fdbf4940><ul class="copyright" data-v-fdbf4940><li class="copyright-item" data-v-fdbf4940><a href="/2020/05/06/kubernetes1/.html" class="nav-link" data-v-fdbf4940>Copyright © 2020 Menfre Blog.</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8d42fabb.js" defer></script><script src="/assets/js/6.aea618f8.js" defer></script><script src="/assets/js/4.20006588.js" defer></script><script src="/assets/js/20.e1896da5.js" defer></script><script src="/assets/js/7.403b6e6e.js" defer></script>
  </body>
</html>
